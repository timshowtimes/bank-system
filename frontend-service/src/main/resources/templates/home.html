<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.05);
        }

        .logout {
            float: right;
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üí≥ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h3>
        <a href="/logout" class="btn btn-outline-danger">–í—ã–π—Ç–∏</a>
    </div>

    <!-- === –ê–∫–∫–∞—É–Ω—Ç === -->
    <div class="card p-3 mb-3">
        <h5 class="mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h5>
        <p><b>–õ–æ–≥–∏–Ω:</b> <span id="user-login">...</span></p>
        <p><b>–ò–º—è:</b> <span id="user-name">...</span></p>
        <p><b>Email:</b> <span id="user-email">...</span></p>
        <p><b>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</b> <span id="user-birth">...</span></p>
        <p><b>–ë–∞–ª–∞–Ω—Å:</b> <span id="user-balance">0 ‚Ç∏</span></p>
        <button class="btn btn-danger" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <div class="card p-3 mb-3">
        <h5>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h5>
        <input id="firstName" class="form-control mb-2" placeholder="–ò–º—è">
        <input id="lastName" class="form-control mb-2" placeholder="–§–∞–º–∏–ª–∏—è">
        <input id="email" type="email" class="form-control mb-2" placeholder="Email">
        <input id="birthDate" type="date" class="form-control mb-2">

        <button class="btn btn-primary" onclick="updateProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>

    <!-- === –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å === -->
    <div class="card p-3 mb-3">
        <h5 class="mb-3">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h5>
        <input id="old-password"
               type="password"
               name="oldPassword"
               placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å"
               required
               class="form-control mb-2"
               autocomplete="new-password"
               autocorrect="off"
               autocapitalize="off"
               spellcheck="false">

        <input id="new-password"
               type="password"
               name="newPassword"
               placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
               required
               class="form-control mb-2"
               autocomplete="new-password">

        <input id="confirm-password"
               type="password"
               name="confirmPassword"
               placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
               required
               class="form-control mb-2"
               autocomplete="new-password">

        <button onclick="changePassword()" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
    </div>

    <!-- === –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º === -->
    <div class="card p-3 mb-3">
        <h5 class="mb-3">–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º</h5>
        <input id="cash-amount" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" class="form-control mb-3">
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-fill" onclick="deposit('put')">–ü–æ–ª–æ–∂–∏—Ç—å</button>
            <button class="btn btn-warning flex-fill" onclick="deposit('get')">–°–Ω—è—Ç—å</button>
        </div>
    </div>

    <!-- === –ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ === -->
    <div class="card p-3 mb-3">
        <h5 class="mb-3">–ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥</h5>
        <input id="transfer-to" placeholder="–ö–æ–º—É (–ª–æ–≥–∏–Ω)" class="form-control mb-2">
        <input id="transfer-amount" type="number" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞" class="form-control mb-2">
        <button class="btn btn-info w-100" style="background-color: #b5e6d1a6; border-color: #0d2b16;"
                onclick="transfer()">
            –ü–µ—Ä–µ–≤–µ—Å—Ç–∏
        </button>
    </div>
</div>

<script>
    let currentAccountId = null;

    // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è ===
    async function loadProfile() {
        try {
            const response = await fetch("/api/v1/frontend/get-account?ts=" + Date.now(), {cache: "no-store"});
            if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å");

            const user = await response.json();
            currentAccountId = user.id;
            console.log("‚úÖ User:", user);

            const el = id => document.getElementById(id);
            if (el("user-login")) el("user-login").innerText = user.login;
            if (el("user-name")) el("user-name").innerText = `${user.firstName ?? ''} ${user.lastName ?? ''}`.trim();
            if (el("user-email")) el("user-email").innerText = user.email ?? '-';
            if (el("user-birth")) el("user-birth").innerText = user.birthDate ?? '-';
            if (el("user-balance")) el("user-balance").innerText = (user.balance ?? 0).toFixed(2) + " ‚Ç∏";

        } catch (err) {
            console.error(err);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è");
        }
    }

    async function updateProfile() {
        const dto = {
            firstName: document.getElementById("firstName").value.trim(),
            lastName: document.getElementById("lastName").value.trim(),
            email: document.getElementById("email").value.trim(),
            birthDate: document.getElementById("birthDate").value
        };

        const res = await fetch(`/api/v1/frontend/${currentAccountId}/update-profile`, {
            method: "PUT",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(dto)
        });

        const msg = await parseErrorResponse(res);
        alert(res.ok ? "‚úÖ " + msg : "‚ùå " + msg);

        if (res.ok) await loadProfile(); // –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    }

    async function deleteAccount() {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) return;

        const res = await fetch(`/api/v1/frontend/${currentAccountId}/delete-account`, {method: "DELETE"});
        const msg = await parseErrorResponse(res);
        alert(res.ok ? "‚úÖ " + msg : "‚ùå " + msg);

        if (res.ok) window.location.href = "/login"; // –†–∞–∑–ª–æ–≥–∏–Ω–∏—Ç—å –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    }

    // === –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è ===
    async function changePassword() {
        const oldPassword = document.getElementById("old-password").value.trim();
        const newPassword = document.getElementById("new-password").value.trim();
        const confirm = document.getElementById("confirm-password").value.trim();

        if (!oldPassword || !newPassword || !confirm) {
            return alert("‚ö†Ô∏è –í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è");
        }

        if (newPassword !== confirm) {
            return alert("‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç");
        }

        try {
            const res = await fetch(`/api/v1/frontend/${currentAccountId}/change-password`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({oldPassword, newPassword})
            });

            const data = await res.json();

            if (res.ok) {
                alert("‚úÖ " + (data.message || "–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω"));
                // –ú–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è
                document.getElementById("old-password").value = "";
                document.getElementById("new-password").value = "";
                document.getElementById("confirm-password").value = "";
            } else {
                alert("‚ùå " + (data.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è"));
            }
        } catch (err) {
            console.error(err);
            alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }
    }


    // === –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ / —Å–Ω—è—Ç–∏–µ ===
    async function deposit(action) {
        const amount = document.getElementById("cash-amount").value;
        if (!amount || amount <= 0) return alert("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É");

        const url = action === 'put'
            ? `/api/v1/frontend/deposit/${currentAccountId}?amount=${amount}`
            : `/api/v1/frontend/withdraw/${currentAccountId}?amount=${amount}`;

        const res = await fetch(url, {method: "POST"});
        // const msg = await res.text();
        if (res.ok) {
            alert("‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
            await loadProfile();
        } else {
            const msg = await parseErrorResponse(res)
            alert("‚ùå –û—à–∏–±–∫–∞: " + msg);
        }
    }

    async function parseErrorResponse(res) {
        try {
            let text = await res.text();

            // üîß –£–¥–∞–ª—è–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ –ø–µ—Ä–µ–¥ JSON (–¥–≤–æ–µ—Ç–æ—á–∏—è, –ø—Ä–æ–±–µ–ª—ã, –Ω–µ–ø–µ—á–∞—Ç–∞–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã)
            text = text.trim().replace(/^[^{]+/, "");

            try {
                const data = JSON.parse(text);
                return data.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            } catch (e) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:", text);
                return text || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            }
        } catch {
            return "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞";
        }
    }


    // === –ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ ===
    async function transfer() {
        const to = document.getElementById("transfer-to").value.trim();
        const amount = parseFloat(document.getElementById("transfer-amount").value);
        if (!to || !amount || amount <= 0) {
            alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ —Å—É–º–º—É");
            return;
        }

        console.log("USER ID: " + currentAccountId)

        const payload = {
            toAccount: to,
            amount: amount,
            fromAccount: currentAccountId
        };

        const res = await fetch("/api/v1/frontend/transfer", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });

        const msg = await parseErrorResponse(res)
        alert(res.ok ? `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!` : `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ: ${msg}`);

        if (res.ok) await loadProfile();
    }

    window.onload = loadProfile;
</script>
</body>
</html>
